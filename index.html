import React, { useState, useEffect, useRef } from 'react';
import { Play, Pause, RotateCcw, Settings, Coffee, Target } from 'lucide-react';

const PomodoroTimer = () => {
  const [timeLeft, setTimeLeft] = useState(25 * 60); // 25 minutes in seconds
  const [isActive, setIsActive] = useState(false);
  const [mode, setMode] = useState('work'); // 'work', 'shortBreak', 'longBreak'
  const [sessions, setSessions] = useState(0);
  const [showSettings, setShowSettings] = useState(false);
  const [settings, setSettings] = useState({
    workTime: 25,
    shortBreak: 5,
    longBreak: 15
  });
  
  const intervalRef = useRef(null);

  const modes = {
    work: { duration: settings.workTime * 60, label: 'Focus Time', icon: Target },
    shortBreak: { duration: settings.shortBreak * 60, label: 'Short Break', icon: Coffee },
    longBreak: { duration: settings.longBreak * 60, label: 'Long Break', icon: Coffee }
  };

  useEffect(() => {
    if (isActive && timeLeft > 0) {
      intervalRef.current = setInterval(() => {
        setTimeLeft(time => time - 1);
      }, 1000);
    } else if (timeLeft === 0) {
      // Timer finished
      setIsActive(false);
      if (mode === 'work') {
        setSessions(prev => prev + 1);
        // Switch to break mode
        const nextMode = sessions > 0 && (sessions + 1) % 4 === 0 ? 'longBreak' : 'shortBreak';
        setMode(nextMode);
        setTimeLeft(modes[nextMode].duration);
      } else {
        // Break finished, back to work
        setMode('work');
        setTimeLeft(modes.work.duration);
      }
      // Play notification sound (browser beep)
      const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+D2v2oeATOS2+zBdisELIXN8jGJOwoUWbXlxKdTEA5Lp+P4t2wfBzuP2PvId3EqBCyEzjKBOAoUWr3iv65XFApLnuL7v1kjBWCz7+OKPh8VaLbnyrRfDQ5SqPb4vW1eDjiP2Pi4dV8rFz');
      audio.play().catch(() => {}); // Ignore errors if audio fails
    } else {
      clearInterval(intervalRef.current);
    }
    
    return () => clearInterval(intervalRef.current);
  }, [isActive, timeLeft, mode, sessions, modes]);

  const toggleTimer = () => {
    setIsActive(!isActive);
  };

  const resetTimer = () => {
    setIsActive(false);
    setTimeLeft(modes[mode].duration);
  };

  const switchMode = (newMode) => {
    setIsActive(false);
    setMode(newMode);
    setTimeLeft(modes[newMode].duration);
  };

  const formatTime = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  };

  const progress = ((modes[mode].duration - timeLeft) / modes[mode].duration) * 100;

  const updateSettings = (newSettings) => {
    setSettings(newSettings);
    setTimeLeft(newSettings[mode === 'work' ? 'workTime' : mode === 'shortBreak' ? 'shortBreak' : 'longBreak'] * 60);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 flex items-center justify-center p-4">
      {/* Background Pattern */}
      <div className="absolute inset-0 opacity-10">
        <div className="absolute inset-0" style={{
          backgroundImage: `url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")`
        }} />
      </div>

      <div className="relative z-10 w-full max-w-md">
        {/* Header with Logo */}
        <div className="text-center mb-8">
          <div className="inline-flex items-center justify-center w-20 h-20 rounded-full bg-gradient-to-br from-cyan-400 to-blue-500 mb-4 shadow-xl shadow-cyan-500/25">
            <div className="w-12 h-12 rounded-full bg-gradient-to-br from-cyan-300 to-blue-400 flex items-center justify-center">
              <div className="w-8 h-8 rounded-full bg-white/20 flex items-center justify-center">
                <div className="w-1 h-4 bg-white rounded-full transform rotate-12"></div>
                <div className="w-1 h-3 bg-white rounded-full transform -rotate-12 ml-1"></div>
              </div>
            </div>
          </div>
          <h1 className="text-3xl font-bold bg-gradient-to-r from-cyan-400 to-white bg-clip-text text-transparent">
            Pomodoro Timer
          </h1>
        </div>

        {/* Main Timer Card */}
        <div className="bg-white/10 backdrop-blur-lg rounded-3xl p-8 shadow-2xl border border-white/20">
          {/* Mode Switcher */}
          <div className="flex gap-2 mb-6">
            {Object.entries(modes).map(([key, modeData]) => {
              const Icon = modeData.icon;
              return (
                <button
                  key={key}
                  onClick={() => switchMode(key)}
                  className={`flex-1 flex items-center justify-center gap-2 py-2 px-3 rounded-xl text-sm font-medium transition-all ${
                    mode === key
                      ? 'bg-gradient-to-r from-cyan-500 to-blue-500 text-white shadow-lg'
                      : 'text-white/70 hover:bg-white/10 hover:text-white'
                  }`}
                >
                  <Icon size={16} />
                  {key === 'work' ? 'Focus' : key === 'shortBreak' ? 'Short' : 'Long'}
                </button>
              );
            })}
          </div>

          {/* Timer Display */}
          <div className="text-center mb-8">
            <div className="relative inline-block">
              {/* Progress Ring */}
              <svg className="transform -rotate-90 w-64 h-64" viewBox="0 0 100 100">
                <circle
                  cx="50"
                  cy="50"
                  r="45"
                  stroke="rgba(255,255,255,0.1)"
                  strokeWidth="2"
                  fill="none"
                />
                <circle
                  cx="50"
                  cy="50"
                  r="45"
                  stroke="url(#gradient)"
                  strokeWidth="2"
                  fill="none"
                  strokeLinecap="round"
                  strokeDasharray={`${2 * Math.PI * 45}`}
                  strokeDashoffset={`${2 * Math.PI * 45 * (1 - progress / 100)}`}
                  className="transition-all duration-1000 ease-out"
                />
                <defs>
                  <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stopColor="#06b6d4" />
                    <stop offset="100%" stopColor="#3b82f6" />
                  </linearGradient>
                </defs>
              </svg>
              
              {/* Time Display */}
              <div className="absolute inset-0 flex flex-col items-center justify-center">
                <div className="text-5xl font-bold text-white mb-2 font-mono">
                  {formatTime(timeLeft)}
                </div>
                <div className="text-cyan-300 text-sm font-medium">
                  {modes[mode].label}
                </div>
              </div>
            </div>
          </div>

          {/* Control Buttons */}
          <div className="flex items-center justify-center gap-4 mb-6">
            <button
              onClick={resetTimer}
              className="p-3 rounded-full bg-white/10 hover:bg-white/20 text-white transition-all hover:scale-110"
            >
              <RotateCcw size={24} />
            </button>
            
            <button
              onClick={toggleTimer}
              className="p-4 rounded-full bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-400 hover:to-blue-400 text-white shadow-xl shadow-cyan-500/25 transition-all hover:scale-110"
            >
              {isActive ? <Pause size={32} /> : <Play size={32} />}
            </button>
            
            <button
              onClick={() => setShowSettings(!showSettings)}
              className="p-3 rounded-full bg-white/10 hover:bg-white/20 text-white transition-all hover:scale-110"
            >
              <Settings size={24} />
            </button>
          </div>

          {/* Sessions Counter */}
          <div className="text-center">
            <div className="text-white/70 text-sm">Sessions Completed</div>
            <div className="text-2xl font-bold text-cyan-300">{sessions}</div>
          </div>

          {/* Settings Panel */}
          {showSettings && (
            <div className="mt-6 p-4 bg-white/5 rounded-xl border border-white/10">
              <h3 className="text-white font-medium mb-4">Settings (minutes)</h3>
              <div className="space-y-3">
                {[
                  { key: 'workTime', label: 'Focus Time' },
                  { key: 'shortBreak', label: 'Short Break' },
                  { key: 'longBreak', label: 'Long Break' }
                ].map(({ key, label }) => (
                  <div key={key} className="flex items-center justify-between">
                    <span className="text-white/80 text-sm">{label}</span>
                    <input
                      type="number"
                      min="1"
                      max="60"
                      value={settings[key]}
                      onChange={(e) => updateSettings({
                        ...settings,
                        [key]: parseInt(e.target.value) || 1
                      })}
                      className="w-16 px-2 py-1 bg-white/10 border border-white/20 rounded text-white text-center"
                    />
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>

        {/* Footer */}
        <div className="text-center mt-6 text-white/60 text-sm">
          Stay focused and productive! 🍅
        </div>
      </div>
    </div>
  );
};

export default PomodoroTimer;
